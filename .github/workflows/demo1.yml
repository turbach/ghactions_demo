name: demo1

defaults:
  run:
    shell:
      # as login shell for conda envs
      bash -l {0}

env:
  PACKAGE_NAME: ghactions_demo
  SPHINX_DOCS_PATH: $HOME/docs
  SPHIX_DOCS_HTML: $HOME/docs/build/html
  CONDA_BLD_PATH: /tmp/bld_dir
  CONDA_LABEL: "cid-test"
  TEST_TARBALL=$CONDA_BLD_PATH/$PACKAGE_NAME-0.0.0.dev0-${PY_VER}_g${GITHUB_SHA:0:8}.tar.bz2

on:
  # all pushes except vM.N.P tagged stable release
  push:
    branches: ["*"]
    tags-ignore: ["v.[0-9].[0-9].[0-9]"]

  pull_request:

  release:
    types: [published]
    branch: main

jobs:
  ci:
    runs-on: [ubuntu-latest]
    strategy:
      matrix:
        pyver: ["3.6", "3.7", "3.8"]
    env:
      PY_VER: ${{ matrix.pyver }}

    # outputs:
    #   deploy-type: ${{ steps.conda-build.outputs.deploy-type }}
    #   tarball: ${{ steps.conda-build.outputs.tarball }}

    steps:
      - uses: actions/checkout@v2

      - name: install
        run: echo "installing $PY_VER"

      - name: build conda pkg
        id: conda-build
        run: |
          echo "building conda pkg $PY_VER"
          # tarball=$CONDA_BLD_PATH/$PACKAGE_NAME-0.0.0.dev0-${PY_VER}_${GITHUB_SHA:0:8}.tar.bz2
          tarball=$TEST_TARBALL
          if [[ $tarball =~ .*([0-9]+\.){3}dev[0-9]+ ]]; then conda_label="pre-release"; fi
          if [[ $tarball =~ .*([0-9]+\.){2}\.[0-9]+ ]]; then conda_label="main"; fi
          # posix to set conda_label to ci_test if unset
          echo "CONDA_LABEL=${conda_label:-ci_test]}" >> $GITHUB_ENV
          echo conda build ${conda_label}
          echo "TARBALL=$tarball" >> $GITHUB_ENV

      - name: pytest
        run: echo pytesting $PY_VER label=$CONDA_LABEL for TARBALL=$TARBALL

      - name: deploy conda pkg
        run: echo conda upload $PY_VER label=$CONDA_LABEL for TARBALL=$TARBALL

      - name: build sphinx docs
        run: echo building sphinx docs $PY_VER label=$CONDA_LABEL for TARBALL=$TARBALL

      - name: deploy sphinx docs
        run: echo ghpages upload $PY_VER label=$CONDA_LABEL for TARBALL=$TARBALL

      - name: build sdist
        run: echo building sdist $PY_VER label=$CONDA_LABEL for TARBALL=$TARBALL

      - name: deploy test.pypi
        run: echo uploading sdist to TEST.pypi.org $PY_VER label=$CONDA_LABEL for TARBALL=$TARBALL

      - name: deploy pypi
        run: echo uploading sdist to PYPI.org $PY_VER label=$CONDA_LABEL for TARBALL=$TARBALL
