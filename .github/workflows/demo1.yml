name: demo1

defaults:
  run:
    shell:
      # as login shell for conda envs
      bash -l {0}

env:
  PACKAGE_NAME: ghactions_demo
  SPHINX_DOCS_PATH: $HOME/docs
  SPHIX_DOCS_HTML: $HOME/docs/build/html
  CONDA_BLD_DIR: /tmp/bld_dir

on:
  push:
    # run on all branches but not tags
    branches: ["*"]
    tags-ignore: ["*"]

  pull_request:

  release:
    types: [published]
    branch: main

jobs:
  ci:
    runs-on: [ubuntu-latest]
    strategy:
      matrix:
        pyver: ["3.6", "3.7", "3.8"]
    env:
      PY_VER: ${{ matrix.pyver }}

    # outputs:
    #   deploy-type: ${{ steps.conda-build.outputs.deploy-type }}
    #   tarball: ${{ steps.conda-build.outputs.tarball }}

    steps:
      - uses: actions/checkout@v2

      - name: install
        run: echo "installing $PY_VER"

      - name: build conda pkg
        id: conda-build
        run: |
          echo "building conda pkg $PY_VER"
          deploy-type="pre-release"
          tarball="${CONDA_BLD_DIR}/ghaction_${PY_VER}.txt"
          echo "DEPLOY_TYPE=$deploy-type" >> $GITHUB_ENV
          echo "TARBALL=$tarball" >> $GITHUB_ENV
          # echo "::set-output name=deploy-type::$DEPLOY_TYPE"
          # echo "::set-output name=tarball::$TARBALL"

          # echo "I am a $DEPLOY_TYPE $PY_VER conda pkg" > ${{ steps.conda-build.outputs.tarball }}
          # echo "conda-build tarball output:" $steps.conda-build.outputs.tarball

      - name: pytest
        run: echo "pytesting $PY_VER for TARBALL=$TARBALL"

      - name: deploy conda pkg
        run: echo "conda upload $PY_VER ${{ steps.conda-build.output.deploy-type }} ${{ steps.conda-build.output.tarball }} "

      - name: build sphinx docs
        run: echo "building sphinx docs $PY_VER ${{ steps.conda-build.output.deploy-type }}"

      - name: deploy sphinx docs
        run: echo "ghpages upload $PY_VER ${{ steps.conda-build.output.deploy-type }}"

      - name: build sdist
        run: echo "building sdist $PY_VER ${{ steps.conda-build.output.deploy-type }}"

      - name: deploy test.pypi
        run: echo "uploading sdist to TEST.pypi.org $PY_VER ${{ steps.conda-build.output.deploy-type }}"

      - name: deploy pypi
        run: echo "uploading sdist to PYPI.org $PY_VER ${{ steps.conda-build.output.deploy-type }}"
